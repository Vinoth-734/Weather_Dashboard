@model WeatherDashboard.ViewModels.WeatherResultViewModel?
@{
    ViewData["Title"] = "Weather Dashboard";
    var lastFive = ViewBag.LastFive as List<WeatherDashboard.Models.CitySearch> ?? new List<WeatherDashboard.Models.CitySearch>();
}

<div class="grid">
    <div>
        <div class="card">
            <form asp-action="Search" method="post" class="form-row" onsubmit="showLoader()">
                <input type="text" name="city" placeholder="Enter city name (e.g., London)" />
                <button type="submit">Search</button>
            </form>
            @if (TempData["Error"] != null)
            {
                <div style="color:crimson;margin-top:.5rem">@TempData["Error"]</div>
            }
        </div>

        @if (Model != null)
        {
            <div class="card" style="margin-top:1rem">
                <h3>@Model.CityName</h3>
                <p>Temperature: @Model.TemperatureC °C</p>
                <p>Humidity: @Model.Humidity %</p>
                <p>Condition: @Model.Condition</p>

                <canvas id="tempChart" width="600" height="250"></canvas>

                @section Scripts {
                    <script>
                        (function(){
                            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ForecastPoints.Select(p => p.DateTime.ToString("MM-dd HH:mm"))));
                            const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ForecastPoints.Select(p => p.Temp)));

                            const ctx = document.getElementById('tempChart').getContext('2d');
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Temperature (°C)',
                                        data: data,
                                        fill: false,
                                        tension: 0.2
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    scales: { x: { display: true } }
                                }
                            });
                        })();
                    </script>
                }
            </div>
        }
    </div>

    <aside>
        <div class="card last-searches">
            <h4>Last 5 searches</h4>
            <ul>
                @if (lastFive.Any())
                {
                    foreach (var c in lastFive)
                    {
                        <li>@c.CityName <small style="color:gray">(@c.SearchedAt.ToLocalTime().ToString("g"))</small></li>
                    }
                }
                else
                {
                    <li>No searches yet</li>
                }
            </ul>
        </div>
    </aside>
</div>
